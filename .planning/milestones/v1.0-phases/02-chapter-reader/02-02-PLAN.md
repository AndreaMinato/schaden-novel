---
phase: 02-chapter-reader
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - app/composables/useChapterNav.ts
  - app/composables/useReadingProgress.ts
  - app/pages/novels/[novel]/[...slug].vue
autonomous: true
requirements: [READ-01, READ-02, READ-03, READ-04, PROG-01]

must_haves:
  truths:
    - "Chapter prose displays within ~65ch max-width with comfortable line-height"
    - "Chapter title appears as breadcrumb (e.g., MGA > Chapter 42)"
    - "Prev/next buttons appear at both top and bottom of the chapter"
    - "Prev button is disabled on first chapter, next button is disabled on last chapter"
    - "Cmd+Left navigates to previous chapter, Cmd+Right navigates to next"
    - "Toast notification shown when pressing shortcut at first or last chapter boundary"
    - "Reading progress saved to localStorage on chapter page load"
    - "Chapter page is readable on phone-sized screens"
  artifacts:
    - path: "app/composables/useChapterNav.ts"
      provides: "Fetch sorted chapter list, compute prev/next from current position"
      exports: ["useChapterNav"]
    - path: "app/composables/useReadingProgress.ts"
      provides: "localStorage read/write of last-read chapter per novel"
      exports: ["useReadingProgress"]
    - path: "app/pages/novels/[novel]/[...slug].vue"
      provides: "Full chapter reader with typography, navigation, keyboard shortcuts, progress"
      contains: "defineShortcuts"
  key_links:
    - from: "app/pages/novels/[novel]/[...slug].vue"
      to: "app/composables/useChapterNav.ts"
      via: "composable call for prev/next chapter data"
      pattern: "useChapterNav"
    - from: "app/pages/novels/[novel]/[...slug].vue"
      to: "app/composables/useReadingProgress.ts"
      via: "save progress on component mount"
      pattern: "useReadingProgress"
    - from: "app/pages/novels/[novel]/[...slug].vue"
      to: "defineShortcuts"
      via: "Nuxt UI keyboard shortcut registration"
      pattern: "meta_arrowleft|meta_arrowright"
    - from: "app/pages/novels/[novel]/[...slug].vue"
      to: "/api content query"
      via: "useChapterNav fetches chapter metadata for navigation"
      pattern: "queryCollection"
---

<objective>
Build the chapter reader page with clean prose typography, prev/next navigation buttons, keyboard shortcuts (Cmd+Arrow), and localStorage reading progress tracking.

Purpose: This is the core reading experience -- the page readers spend 99% of their time on. Typography, navigation, and progress tracking must all work together seamlessly.
Output: Fully functional chapter reader with composables for navigation and progress.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-chapter-reader/02-RESEARCH.md
@.planning/phases/02-chapter-reader/02-01-SUMMARY.md
@app/pages/novels/[novel]/[...slug].vue
@content.config.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create useChapterNav and useReadingProgress composables</name>
  <files>
    app/composables/useChapterNav.ts
    app/composables/useReadingProgress.ts
  </files>
  <action>
Create two composables in `app/composables/`:

**app/composables/useChapterNav.ts:**
Export an async function `useChapterNav(novel: string, currentPath: string)` that returns `{ prev, next, chapters }` as computed refs.

Implementation:
1. Fetch all chapters for the novel: `useAsyncData(`nav-${novel}`, () => queryCollection(novel as any).select('title', 'path', 'stem').all())`.
2. Create `sortedChapters` computed: sort ASCENDING with `a.stem.localeCompare(b.stem, undefined, { numeric: true, sensitivity: 'base' })`. Ascending for navigation (prev = lower index, next = higher index).
3. Create `currentIndex` computed: `sortedChapters.value.findIndex(ch => ch.path === currentPath)`.
4. Create `prev` computed: `currentIndex > 0 ? sortedChapters[currentIndex - 1] : null`.
5. Create `next` computed: `currentIndex < sortedChapters.length - 1 ? sortedChapters[currentIndex + 1] : null`.
6. Return `{ prev, next, chapters: sortedChapters }`.

Note: This composable must be called with `await` since it uses `useAsyncData` internally. The `currentPath` is the CONTENT path (e.g., `/mga/42`), not the route path.

**app/composables/useReadingProgress.ts:**
Export a function `useReadingProgress()` returning `{ save, get }`.

Implementation:
- `const STORAGE_KEY = 'schaden-reading-progress'`
- `save(novel: string, chapterPath: string)`: Guard with `if (!import.meta.client) return`. Try/catch: parse existing JSON from `localStorage.getItem(STORAGE_KEY)` (default `{}`), set `data[novel] = chapterPath`, write back with `JSON.stringify`.
- `get(novel: string): string | null`: Guard with `if (!import.meta.client) return null`. Try/catch: parse JSON, return `data[novel] || null`.
- The `chapterPath` stored is the ROUTE path (e.g., `/novels/mga/42`) so it can be used directly for navigation in Phase 3's resume-reading feature.
  </action>
  <verify>
Verify files exist and export correctly: `grep -n 'export' app/composables/useChapterNav.ts app/composables/useReadingProgress.ts`. Run `nuxt generate` to confirm no import errors.
  </verify>
  <done>
useChapterNav returns reactive prev/next chapter objects sorted by natural numeric order. useReadingProgress reads/writes per-novel chapter paths to localStorage. Both composables are auto-imported by Nuxt.
  </done>
</task>

<task type="auto">
  <name>Task 2: Rewrite chapter reader with typography, navigation, keyboard shortcuts, and progress</name>
  <files>
    app/pages/novels/[novel]/[...slug].vue
  </files>
  <action>
Rewrite `app/pages/novels/[novel]/[...slug].vue` to replace the Phase 1 placeholder. This is the core reading page.

**Script setup:**
1. Extract params: `const novel = route.params.novel as string`, `const slug = (route.params.slug as string[]).join('/')`.
2. Derive content path: `const contentPath = `/${novel}/${slug}``.
3. Fetch chapter: `useAsyncData(`chapter-${novel}-${slug}`, () => queryCollection(novel as any).path(contentPath).first())`.
4. 404 guard: `if (!chapter.value) throw createError({ statusCode: 404, message: 'Chapter not found' })`.
5. Chapter navigation: `const { prev, next } = await useChapterNav(novel, contentPath)`.
6. Reading progress: On mount, save the ROUTE path: `onMounted(() => { useReadingProgress().save(novel, `/novels${contentPath}`) })`.
7. Breadcrumb items: `computed<BreadcrumbItem[]>(() => [{ label: novel.toUpperCase(), to: `/novels/${novel}` }, { label: chapter.value?.title || `Chapter ${slug}` }])`. Import `BreadcrumbItem` type from `@nuxt/ui`.
8. Navigation helper: `function navigateTo(path: string) { return navigateTo(`/novels${path}`) }` -- wait, `navigateTo` is a Nuxt global. Use it directly.
9. Keyboard shortcuts using Nuxt UI `defineShortcuts`:
```typescript
const toast = useToast()
defineShortcuts({
  meta_arrowleft: () => {
    if (prev.value) {
      navigateTo(`/novels${prev.value.path}`)
    } else {
      toast.add({ title: 'First chapter', color: 'neutral', duration: 2000 })
    }
  },
  meta_arrowright: () => {
    if (next.value) {
      navigateTo(`/novels${next.value.path}`)
    } else {
      toast.add({ title: 'Last chapter', color: 'neutral', duration: 2000 })
    }
  },
})
```

**Template structure:**
```
<div class="max-w-[65ch] mx-auto px-4 sm:px-6 py-8">
  <!-- Breadcrumb title -->
  <UBreadcrumb :items="breadcrumbItems" class="mb-4" />

  <!-- Top navigation -->
  <nav class="flex justify-between items-center mb-8">
    <UButton
      :to="prev ? `/novels${prev.path}` : undefined"
      :disabled="!prev"
      icon="i-lucide-chevron-left"
      variant="outline"
      label="Previous"
      size="sm"
    />
    <UButton
      :to="next ? `/novels${next.path}` : undefined"
      :disabled="!next"
      icon="i-lucide-chevron-right"
      trailing
      variant="outline"
      label="Next"
      size="sm"
    />
  </nav>

  <!-- Chapter prose -->
  <article class="prose prose-lg dark:prose-invert max-w-none leading-relaxed">
    <ContentRenderer v-if="chapter" :value="chapter" />
  </article>

  <!-- Bottom navigation (identical to top) -->
  <nav class="flex justify-between items-center mt-8 pt-8 border-t border-gray-200 dark:border-gray-800">
    <!-- Same UButton pair as top nav -->
  </nav>
</div>
```

**Key styling decisions (Claude's discretion per CONTEXT.md):**
- `max-w-[65ch]` for the ~65ch reading column (user locked decision).
- `prose prose-lg dark:prose-invert` for clean typography with dark mode support. Tailwind Typography plugin is included via Nuxt UI.
- `leading-relaxed` (~1.625 line-height) for comfortable reading.
- `px-4 sm:px-6` for mobile padding (4 on small screens, 6 on sm+).
- `size="sm"` on nav buttons for non-intrusive navigation.
- Border-top separator on bottom nav to visually distinguish from content.

**Mobile responsiveness (READ-04):**
- `max-w-[65ch]` naturally constrains on large screens, flows to full width on small.
- `px-4` provides mobile edge padding.
- `sm:px-6` increases padding on tablet+.
- Buttons use `size="sm"` which remains touch-friendly (44px+ tap target with padding).
- Prose font size from `prose-lg` scales appropriately.

Do NOT use `UContentSurround` or `queryCollectionItemSurroundings` -- they use alphabetical sort which breaks numeric chapter ordering (per research findings).
  </action>
  <verify>
Run `nuxt generate` -- build must complete without errors. Serve output and verify:
1. `curl -s http://localhost:3456/novels/lrg/1/ | grep -c 'Previous'` returns 2 (top + bottom nav).
2. `curl -s http://localhost:3456/novels/lrg/1/ | grep 'disabled'` shows at least one disabled button (prev on first chapter).
3. `curl -s http://localhost:3456/novels/lrg/1/ | grep 'defineShortcuts\|meta_arrow'` -- this won't appear in HTML output, so instead verify the script compiled: check build succeeds with no type errors.
4. `curl -s http://localhost:3456/novels/lrg/1/ | grep '65ch'` confirms max-width styling is present.
  </verify>
  <done>
Chapter reader at /novels/{novel}/{slug} displays prose in a ~65ch reading column with breadcrumb title, prev/next buttons at top and bottom (disabled at boundaries), Cmd+Arrow keyboard shortcuts with boundary toast, and reading progress saved to localStorage on load. Page is mobile-responsive.
  </done>
</task>

</tasks>

<verification>
- `nuxt generate` completes without errors
- Chapter reader renders prose with max-w-[65ch] and prose-lg typography
- Prev/next buttons appear twice (top and bottom)
- First chapter has prev button disabled, last chapter has next disabled
- defineShortcuts registered for meta_arrowleft and meta_arrowright
- useReadingProgress.save() called on mount with route path
- Page uses responsive padding (px-4 sm:px-6)
</verification>

<success_criteria>
- Chapter prose is readable: narrow column, generous line-height, dark mode support
- Navigation works: prev/next buttons link correctly, disabled at boundaries
- Keyboard works: Cmd+Left/Right trigger navigation, toast at boundaries
- Progress works: localStorage entry created on chapter load with route path
- Mobile works: content is readable on small screens with appropriate padding
- No usage of queryCollectionItemSurroundings or UContentSurround
</success_criteria>

<output>
After completion, create `.planning/phases/02-chapter-reader/02-02-SUMMARY.md`
</output>
