---
phase: 03-full-site-parity
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - server/routes/rss.xml.ts
  - server/routes/novels/[novel]/rss.xml.ts
  - nuxt.config.ts
autonomous: true
requirements: [DISC-01, DISC-02]

must_haves:
  truths:
    - "/rss.xml returns valid RSS XML with last 50 chapters across all novels, link only"
    - "/novels/{novel}/rss.xml returns valid RSS XML with last 50 chapters for that novel with full content"
    - "/sitemap.xml returns a sitemap index linking to per-novel sitemaps"
    - "Per-novel sitemaps cover all chapter pages for that novel"
    - "RSS feeds are prerendered and accessible in static deploy"
  artifacts:
    - path: "server/routes/rss.xml.ts"
      provides: "Global RSS feed server route"
      contains: "Feed"
    - path: "server/routes/novels/[novel]/rss.xml.ts"
      provides: "Per-novel RSS feed server route"
      contains: "Feed"
    - path: "nuxt.config.ts"
      provides: "Sitemap module config and RSS prerender routes"
      contains: "@nuxtjs/sitemap"
  key_links:
    - from: "server/routes/rss.xml.ts"
      to: "queryCollection"
      via: "queryCollection(event, novel) server-side API"
      pattern: "queryCollection\\(event"
    - from: "server/routes/novels/[novel]/rss.xml.ts"
      to: "queryCollection"
      via: "queryCollection(event, novel) server-side API for single novel"
      pattern: "queryCollection\\(event"
    - from: "nuxt.config.ts"
      to: "@nuxtjs/sitemap"
      via: "Module registration + sitemaps config"
      pattern: "sitemap"
    - from: "nuxt.config.ts"
      to: "server/routes/rss.xml.ts"
      via: "nitro.prerender.routes includes /rss.xml"
      pattern: "rss\\.xml"
---

<objective>
Add RSS feeds and sitemap generation — the discovery layer that enables feed readers and search engines to find content.

Purpose: Feed readers can subscribe to chapter updates. Search engines can discover and index all chapter pages.
Output: Global + per-novel RSS server routes, @nuxtjs/sitemap multi-sitemap configuration, prerender config for static deploy.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-full-site-parity/03-CONTEXT.md
@.planning/phases/03-full-site-parity/03-RESEARCH.md

@nuxt.config.ts
@content.config.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install dependencies and create RSS feed server routes</name>
  <files>
    package.json
    server/routes/rss.xml.ts
    server/routes/novels/[novel]/rss.xml.ts
  </files>
  <action>
    **1. Install dependencies:**
    ```bash
    pnpm add feed @nuxtjs/sitemap
    ```

    **2. Create `server/routes/rss.xml.ts` (global RSS feed):**
    Per user decision: last 50 chapters across all novels, link only (no full text).

    - Import `Feed` from 'feed'
    - Define the 10 novel slugs inline: `['mga', 'atg', 'overgeared', 'tmw', 'htk', 'issth', 'cd', 'lrg', 'mw', 'rtw']`
    - Define a novel names map inline (same as useNovelMeta but server-side — composables are not available in Nitro server routes)
    - Create Feed instance with id, title ('Schaden Novels'), description, link (use `https://schaden-novel.netlify.app`), copyright
    - For each novel, use `queryCollection(event, novel as any).select('title', 'path', 'pubDate').order('pubDate', 'DESC').limit(50).all()`
    - Use `Promise.all()` to parallelize queries (avoid N+1 sequential pattern)
    - Merge all chapters into one array, sort by pubDate descending, take first 50
    - For each chapter: `feed.addItem({ title, link: 'https://schaden-novel.netlify.app/novels' + ch.path, date: new Date(ch.pubDate) })`
    - Set response header `Content-Type: application/xml; charset=utf-8`
    - Return `feed.rss2()`
    - Wrap in try/catch — on error, return minimal valid RSS with 0 items rather than crashing

    **3. Create `server/routes/novels/[novel]/rss.xml.ts` (per-novel RSS feed):**
    Per user decision: last 50 chapters for this novel, full chapter content included.

    - Import `Feed` from 'feed'
    - Get novel slug from `getRouterParam(event, 'novel')`
    - Validate novel is in the known slugs list; if not, throw `createError({ statusCode: 404, message: 'Novel not found' })`
    - Create Feed instance with novel-specific title and link
    - Query: `queryCollection(event, novel as any).select('title', 'path', 'pubDate', 'rawbody').order('pubDate', 'DESC').limit(50).all()`
    - For full content: Try using the `rawbody` field (raw markdown) as content. If `rawbody` is unavailable, try reading the raw .md file from filesystem: `readFileSync(resolve('content', novel, slug + '.md'), 'utf-8')`. If both fail, fall back to link-only (no content field).
    - For each chapter: `feed.addItem({ title, link, date, content: rawMarkdown || undefined })`
    - Set Content-Type and return `feed.rss2()`
    - Handle empty collections gracefully (return valid RSS with 0 items)
  </action>
  <verify>
    - `ls server/routes/rss.xml.ts server/routes/novels/\\[novel\\]/rss.xml.ts` — both files exist
    - `grep -c 'Feed' server/routes/rss.xml.ts` — confirms feed import
    - `grep -c 'queryCollection' server/routes/rss.xml.ts` — confirms server-side content query
    - `grep -c 'getRouterParam' server/routes/novels/\\[novel\\]/rss.xml.ts` — confirms dynamic novel param
    - `grep 'feed' package.json` — confirms feed dependency installed
  </verify>
  <done>
    Global RSS at /rss.xml queries all 10 novels, merges, returns top 50 chapters as link-only RSS XML. Per-novel RSS at /novels/{novel}/rss.xml returns top 50 chapters for that novel with full markdown content. Both handle empty collections and errors gracefully.
  </done>
</task>

<task type="auto">
  <name>Task 2: Configure sitemap module and add RSS prerender routes to nuxt.config.ts</name>
  <files>
    nuxt.config.ts
  </files>
  <action>
    **1. Add @nuxtjs/sitemap to modules array:**
    - Add `'@nuxtjs/sitemap'` after existing modules in nuxt.config.ts

    **2. Add site URL config:**
    - Add `site: { url: 'https://schaden-novel.netlify.app' }` to the Nuxt config (required by @nuxtjs/sitemap)

    **3. Configure multi-sitemap:**
    Per user decision: sitemap index + per-novel sitemaps covering catalog, novel detail, and chapter pages.

    ```typescript
    sitemap: {
      sitemaps: {
        pages: {
          include: ['/', '/novels', '/novels/*'],
          exclude: ['/novels/*/*'],
        },
        mga: { include: ['/novels/mga/**'] },
        atg: { include: ['/novels/atg/**'] },
        overgeared: { include: ['/novels/overgeared/**'] },
        tmw: { include: ['/novels/tmw/**'] },
        htk: { include: ['/novels/htk/**'] },
        issth: { include: ['/novels/issth/**'] },
        cd: { include: ['/novels/cd/**'] },
        lrg: { include: ['/novels/lrg/**'] },
        mw: { include: ['/novels/mw/**'] },
        rtw: { include: ['/novels/rtw/**'] },
      },
    },
    ```

    **4. Add RSS feed routes to nitro.prerender.routes:**
    - Add `/rss.xml` to the existing prerender routes array
    - Add per-novel RSS routes ONLY for novels that currently have content: `/novels/mga/rss.xml`, `/novels/lrg/rss.xml`
    - Comment: "Add more novel RSS routes as content is migrated"
    - Keep existing prerender routes (/, /200.html, /404.html)

    **5. Verify no conflicts:**
    - Ensure the `prerender:routes` hook still works alongside sitemap module
    - The sitemap module should auto-discover routes from the prerender config
    - Keep `crawlLinks: false` to prevent discovering all 13K chapters via crawling
  </action>
  <verify>
    - `grep -c '@nuxtjs/sitemap' nuxt.config.ts` — module registered
    - `grep -c 'sitemaps' nuxt.config.ts` — multi-sitemap configured
    - `grep -c 'rss.xml' nuxt.config.ts` — RSS routes in prerender
    - `grep -c 'site:' nuxt.config.ts` or `grep 'schaden-novel.netlify.app' nuxt.config.ts` — site URL configured
    - `npx nuxi prepare` completes without errors
  </verify>
  <done>
    nuxt.config.ts has @nuxtjs/sitemap module with per-novel multi-sitemap config. Site URL set for absolute URL generation. RSS feed routes added to nitro prerender for static deploy. Sitemap index at /sitemap.xml links to per-novel sitemaps covering all chapter pages.
  </done>
</task>

</tasks>

<verification>
1. `pnpm list feed @nuxtjs/sitemap` — both dependencies installed
2. Global RSS route file exists at server/routes/rss.xml.ts with Feed import and multi-collection query
3. Per-novel RSS route file exists at server/routes/novels/[novel]/rss.xml.ts with dynamic param
4. nuxt.config.ts has @nuxtjs/sitemap in modules, site URL, multi-sitemap config, and RSS prerender routes
5. `npx nuxi prepare` completes without errors
6. RSS prerender routes include /rss.xml, /novels/mga/rss.xml, /novels/lrg/rss.xml
</verification>

<success_criteria>
- `npx nuxi prepare` completes without errors
- Both server route files exist and import Feed from 'feed'
- nuxt.config.ts properly configures sitemap module with per-novel sitemaps
- RSS routes are included in nitro prerender routes for static deploy
- All 10 novels have sitemap entries in the multi-sitemap config
</success_criteria>

<output>
After completion, create `.planning/phases/03-full-site-parity/03-02-SUMMARY.md`
</output>
