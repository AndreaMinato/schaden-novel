---
phase: 02-chapter-reader
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - app/layouts/default.vue
  - app/composables/useAutoHideHeader.ts
  - app/router.options.ts
  - app/app.vue
  - app/pages/novels/[novel]/index.vue
autonomous: true
requirements: [CATL-03]

must_haves:
  truths:
    - "Novel detail page lists all chapters in correct numeric descending order (latest first)"
    - "Chapters with suffixes like _b sort correctly (e.g., 1632, 1632_a, 1633)"
    - "Header hides when user scrolls down and reappears when scrolling up"
    - "Header is always visible near the top of the page"
    - "Navigating between pages scrolls to top instantly"
  artifacts:
    - path: "app/layouts/default.vue"
      provides: "Default layout with auto-hide header and main content slot"
      min_lines: 20
    - path: "app/composables/useAutoHideHeader.ts"
      provides: "Scroll direction detection for header visibility"
      exports: ["useAutoHideHeader"]
    - path: "app/router.options.ts"
      provides: "Scroll-to-top on route navigation"
      contains: "scrollBehavior"
    - path: "app/pages/novels/[novel]/index.vue"
      provides: "Novel detail page with full descending chapter listing"
      contains: "localeCompare"
  key_links:
    - from: "app/layouts/default.vue"
      to: "app/composables/useAutoHideHeader.ts"
      via: "composable import for header visibility toggle"
      pattern: "useAutoHideHeader"
    - from: "app/pages/novels/[novel]/index.vue"
      to: "queryCollection"
      via: "content query sorted client-side with natural numeric sort"
      pattern: "localeCompare.*numeric"
    - from: "app/app.vue"
      to: "app/layouts/default.vue"
      via: "NuxtLayout component"
      pattern: "NuxtLayout"
---

<objective>
Build the site layout with auto-hide header, scroll-to-top navigation, and the novel detail page showing all chapters in correct descending numeric order.

Purpose: Provides the shared layout infrastructure (header, scroll behavior) that all pages use, and the chapter listing page readers need to find and open chapters.
Output: Working layout with auto-hide header, novel detail page listing chapters descending.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-chapter-reader/02-RESEARCH.md
@app/app.vue
@app/pages/novels/[novel]/index.vue
@nuxt.config.ts
@content.config.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create default layout with auto-hide header and scroll-to-top router config</name>
  <files>
    app/composables/useAutoHideHeader.ts
    app/router.options.ts
    app/layouts/default.vue
    app/app.vue
  </files>
  <action>
Create three new files and modify app.vue:

**app/composables/useAutoHideHeader.ts:**
Export `useAutoHideHeader()` returning `{ isVisible: Ref<boolean> }`.
- Track scroll direction via `window.addEventListener('scroll', handler, { passive: true })`.
- Use `requestAnimationFrame` to throttle (set a `ticking` boolean, skip if already ticking).
- Logic: if `window.scrollY < 60`, always visible. Otherwise, visible when `currentY < lastScrollY` (scrolling up).
- `onMounted` to add listener, `onUnmounted` to remove.
- Start with `isVisible = true`.

**app/router.options.ts:**
Export a `RouterConfig` object with `scrollBehavior(to, from, savedPosition)`.
- If `savedPosition` exists (browser back/forward), return it.
- Otherwise return `{ top: 0, behavior: 'instant' }` so chapter-to-chapter navigation always starts at top.
- Import type `RouterConfig` from `@nuxt/schema`.

**app/layouts/default.vue:**
- `<script setup>`: call `useAutoHideHeader()`, destructure `isVisible`.
- `<template>`:
  - A `<header>` element: `fixed top-0 left-0 right-0 z-50 bg-white dark:bg-gray-950 border-b border-gray-200 dark:border-gray-800 transition-transform duration-300 ease-in-out` with `:class="{ '-translate-y-full': !isVisible }"`.
  - Inside header: a `<div>` with `max-w-4xl mx-auto px-4 h-14 flex items-center`. Contains a `<NuxtLink to="/" class="text-lg font-semibold">Schaden</NuxtLink>`.
  - A `<main>` element with `pt-14` (clears the fixed header height) wrapping `<slot />`.

**app/app.vue:**
Add `<NuxtLayout>` wrapper around `<NuxtPage />` inside `<UApp>`:
```vue
<template>
  <UApp>
    <NuxtLayout>
      <NuxtPage />
    </NuxtLayout>
  </UApp>
</template>
```
  </action>
  <verify>
Run `nuxt generate` -- build must complete without errors. Verify files exist: `ls app/composables/useAutoHideHeader.ts app/router.options.ts app/layouts/default.vue`. Grep for `useAutoHideHeader` in default.vue and `scrollBehavior` in router.options.ts.
  </verify>
  <done>
Layout renders a fixed header with site name linking to "/". Header hides via CSS transform when isVisible is false. Router scrolls to top on navigation. Build passes.
  </done>
</task>

<task type="auto">
  <name>Task 2: Rewrite novel detail page with natural sort descending and styled listing</name>
  <files>
    app/pages/novels/[novel]/index.vue
  </files>
  <action>
Rewrite `app/pages/novels/[novel]/index.vue` to replace the Phase 1 placeholder.

**Script setup:**
- Extract `novel` from `route.params.novel as string`.
- Query chapters: `useAsyncData(`listing-${novel}`, () => queryCollection(novel as any).select('title', 'path', 'stem').all())`.
- Remove `.order('stem', 'ASC')` from the query -- do NOT trust SQL sort for numeric filenames.
- Create `chapters` computed that sorts DESCENDING (latest first per user decision): `[...rawChapters.value].sort((a, b) => b.stem.localeCompare(a.stem, undefined, { numeric: true, sensitivity: 'base' }))`.
- Derive display name: `novel.toUpperCase()` for the title.

**Template:**
- Container: `<div class="max-w-4xl mx-auto px-4 py-8">`.
- Title: `<h1 class="text-2xl font-bold mb-1">{{ novel.toUpperCase() }}</h1>`.
- Chapter count: `<p class="text-sm text-gray-500 dark:text-gray-400 mb-6">{{ chapters.length }} chapters</p>`.
- Chapter list: `<ul class="space-y-1">` with `<li v-for="ch in chapters" :key="ch.path">`.
- Each chapter: `<NuxtLink :to="`/novels${ch.path}`" class="block py-2 px-3 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors">{{ ch.title }}</NuxtLink>`.
- Empty state: `<p v-if="!chapters.length">No chapters found.</p>`.

The sort uses `b.stem.localeCompare(a.stem, ...)` (b before a) for descending order so the latest/highest-numbered chapter appears first.
  </action>
  <verify>
Run `nuxt generate` -- build completes. Serve the output (`npx serve .output/public -p 3456`) and curl the listing page: `curl -s http://localhost:3456/novels/lrg/ | grep -c 'href="/novels/lrg/'` should return a count close to 84 (the number of lrg chapters). Verify the first link in the HTML output is a high-numbered chapter (descending order), not chapter 1.
  </verify>
  <done>
Novel detail page at /novels/{novel}/ lists all chapters sorted descending by numeric stem. Latest chapters appear first. Each chapter links to /novels/{novel}/{slug}. Chapter count is displayed.
  </done>
</task>

</tasks>

<verification>
- `nuxt generate` completes without errors
- Novel listing page renders with chapters in descending numeric order
- Auto-hide header renders on all pages
- Layout wraps page content correctly (NuxtLayout in app.vue)
- `app/router.options.ts` exports scrollBehavior returning top: 0
</verification>

<success_criteria>
- Novel detail page lists chapters sorted descending with natural numeric sort (1887, 1886, ... 2, 1)
- Chapters with suffixes like 1632_a sort between 1632 and 1633
- Layout header is fixed-position with auto-hide transform class
- Router configuration scrolls to top on page transitions
- Build passes with all existing content
</success_criteria>

<output>
After completion, create `.planning/phases/02-chapter-reader/02-01-SUMMARY.md`
</output>
