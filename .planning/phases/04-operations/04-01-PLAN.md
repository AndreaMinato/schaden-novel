---
phase: 04-operations
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - scripts/import.mjs
  - scripts/import_ids.mjs
  - scripts/readChapters.mjs
autonomous: true
requirements:
  - OPS-01
  - OPS-02

must_haves:
  truths:
    - "Import scripts write chapter files to content/{novel}/ not src/content/novels/{novel}/"
    - "Errors during doc fetch are logged to stderr and import-errors.log, not silently swallowed"
    - "Import run prints summary: X imported, Y failed, Z skipped"
    - "appendFile calls are awaited to prevent race conditions"
  artifacts:
    - path: "scripts/readChapters.mjs"
      provides: "Chapter splitter with corrected output path"
      contains: "./content/"
    - path: "scripts/import.mjs"
      provides: "TOC-based Google Docs importer with error handling"
      contains: "import-errors.log"
    - path: "scripts/import_ids.mjs"
      provides: "Direct-ID Google Docs importer with error handling"
      contains: "import-errors.log"
  key_links:
    - from: "scripts/readChapters.mjs"
      to: "content/{tag}/"
      via: "createFile output path"
      pattern: "\\./content/"
    - from: "scripts/import.mjs"
      to: "scripts/readChapters.mjs"
      via: "import { writeChapters }"
      pattern: "writeChapters"
---

<objective>
Port Google Docs import scripts to Nuxt Content directory structure and fix silent error handling.

Purpose: OPS-01 (port import workflow) and OPS-02 (fix error swallowing). Three scripts need path updates and error handling overhaul.
Output: Updated scripts/import.mjs, scripts/import_ids.mjs, scripts/readChapters.mjs
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-operations/04-RESEARCH.md
@scripts/import.mjs
@scripts/import_ids.mjs
@scripts/readChapters.mjs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update readChapters.mjs output path</name>
  <files>scripts/readChapters.mjs</files>
  <action>
Change the output path in the `createFile` function from:
```
const path = './src/content/novels/' + tag + '/' + number + '.md'
```
to:
```
const path = './content/' + tag + '/' + number + '.md'
```

This is the ONLY change needed in readChapters.mjs. The chapter splitting logic, frontmatter generation, multi-part suffix handling (_a, _b, _c, _d), and existsSync skip logic all remain unchanged.
  </action>
  <verify>
Run `node --check scripts/readChapters.mjs` — must exit 0 (no syntax errors).
Grep for `src/content/novels` in the file — must return no matches.
Grep for `./content/` in the file — must return the path line.
  </verify>
  <done>readChapters.mjs writes to content/{tag}/{number}.md instead of src/content/novels/{tag}/{number}.md</done>
</task>

<task type="auto">
  <name>Task 2: Port import.mjs and import_ids.mjs with error handling</name>
  <files>scripts/import.mjs, scripts/import_ids.mjs</files>
  <action>
For BOTH scripts, apply identical error handling pattern:

**1. Add tracking state at module level (after imports):**
```javascript
let imported = 0, failed = 0, skipped = 0
const errors = []
```

**2. Fix silent catch in per-chapter loop (import.mjs lines 54-61, import_ids.mjs lines 37-44):**
Replace the empty `catch (error) { }` with:
```javascript
catch (error) {
  failed++
  const msg = `[${novel}] Failed to load doc ${id}: ${error.message}`
  console.error(msg)
  errors.push(msg)
}
```
Also add `imported++` after successful appendFile, and `await` before `appendFile(...)`.

**3. Fix silent catch in loadAll (import.mjs lines 84-89):**
Replace `catch { }` with:
```javascript
catch (error) {
  const msg = `[${novel}] Novel import failed: ${error.message}`
  console.error(msg)
  errors.push(msg)
}
```
(import_ids.mjs uses explicit `await loadNovel('atg')` calls — wrap each in try/catch with same pattern, OR wrap the sequence in a single try/catch. Simpler: add a `loadAll` wrapper function with try/catch per novel matching the import.mjs pattern.)

**4. Add summary + error file at end of loadAll:**
```javascript
console.log(`\nImport complete: ${imported} imported, ${failed} failed, ${skipped} skipped`)
if (errors.length > 0) {
  await writeFile('./import-errors.log', errors.join('\n') + '\n')
  console.error(`Errors written to import-errors.log`)
}
```

**5. In import.mjs line 57, add `await`:**
Change `appendFile(...)` to `await appendFile(...)` — this is a race condition fix (the combined chapters.md may be read before all appends complete).

Same fix in import_ids.mjs line 40.

Do NOT change: the novels object, the Google Docs URL format, the loadGoogleDoc function, the sleep timing, the writeChapters call, the tmp cleanup. This is a faithful port — only paths and error handling change.
  </action>
  <verify>
Run `node --check scripts/import.mjs` — must exit 0.
Run `node --check scripts/import_ids.mjs` — must exit 0.
Grep for `catch\s*\{\s*\}` or `catch (error) {\s*\n\s*\}` across both files — must return NO matches (no empty catch blocks).
Grep for `import-errors.log` in both files — must return matches.
Grep for `imported.*failed.*skipped` in both files — must return summary lines.
Grep for `await appendFile` in both files — must return matches (no un-awaited appendFile).
  </verify>
  <done>Both import scripts log errors visibly (stderr + file), print run summaries, and await all async operations. Zero silent catch blocks remain.</done>
</task>

</tasks>

<verification>
1. `node --check scripts/import.mjs && node --check scripts/import_ids.mjs && node --check scripts/readChapters.mjs` — all pass
2. `grep -r 'src/content/novels' scripts/` — returns nothing (old paths removed)
3. `grep -rn 'catch.*{' scripts/import.mjs scripts/import_ids.mjs` — every catch block has error handling code (no empty bodies)
4. `grep -c 'await appendFile' scripts/import.mjs scripts/import_ids.mjs` — both files show at least 1 match
</verification>

<success_criteria>
- Running `node scripts/import.mjs` would write chapters to content/{novel}/ (not testable without live Google Docs, but paths verified via grep)
- All 3 silent catch blocks replaced with warn+continue+log pattern
- Import summary (imported/failed/skipped counts) prints at end of every run
- Error log file written when failures occur
- No race conditions from un-awaited appendFile
</success_criteria>

<output>
After completion, create `.planning/phases/04-operations/04-01-SUMMARY.md`
</output>
