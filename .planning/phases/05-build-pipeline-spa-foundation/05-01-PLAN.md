---
phase: 05-build-pipeline-spa-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - modules/body-extractor.ts
  - nuxt.config.ts
  - content.config.ts
  - package.json
  - scripts/strip-dump-bodies.mjs
autonomous: true
requirements:
  - BUILD-01
  - BUILD-02
  - BUILD-03
  - BUILD-04

must_haves:
  truths:
    - "Running `nuxt generate` produces individual JSON body files for each chapter in .output/public/content/novels/{novel}/{stem}.json"
    - "SQL dump files in .output/public/__nuxt_content/ are body-stripped (~2.6MB total, not 64MB)"
    - "Build prerenders only ~25 shell pages (home, catalog, novel listings, RSS, sitemaps) -- not 26K chapter routes"
    - "Build completes in under 3 minutes (target 2 min, 3 min acceptable with body extraction overhead)"
    - "bodies-manifest.json exists in output with file count, paths, and sizes"
  artifacts:
    - path: "modules/body-extractor.ts"
      provides: "Nuxt module that extracts chapter bodies to JSON files and strips them from SQL dump"
      contains: "defineNuxtModule"
    - path: "nuxt.config.ts"
      provides: "Build config with explicit ~25 prerender routes, body-extractor module, spaLoadingTemplate"
      contains: "body-extractor"
    - path: "content.config.ts"
      provides: "Collection definitions wrapped with asSitemapCollection for chapter URL discovery"
      contains: "asSitemapCollection"
    - path: "package.json"
      provides: "Build script using nuxt generate instead of nuxt build"
      contains: "nuxt generate"
  key_links:
    - from: "modules/body-extractor.ts"
      to: "nuxt.config.ts"
      via: "module registration in modules array"
      pattern: "~/modules/body-extractor"
    - from: "modules/body-extractor.ts"
      to: ".output/public/content/novels/"
      via: "close hook copies staged files to build output"
      pattern: "cpSync"
    - from: "content.config.ts"
      to: "sitemap generation"
      via: "asSitemapCollection wrapping enables URL discovery without prerendering"
      pattern: "asSitemapCollection"
---

<objective>
Create the body-extractor Nuxt module and reconfigure the build pipeline to produce SPA-ready output: individual JSON body files for all 13,318 chapters, body-stripped SQL dumps, and only ~25 prerendered shell pages.

Purpose: Eliminate the 10-minute full-static build (26K routes) by extracting chapter bodies at parse time and prerendering only shell pages. This is the core infrastructure for the SPA migration.
Output: Working build pipeline that produces body JSON files + stripped SQL dumps + ~25 prerendered pages in under 3 minutes.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-build-pipeline-spa-foundation/05-RESEARCH.md
@nuxt.config.ts
@content.config.ts
@package.json
@scripts/strip-dump-bodies.mjs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create body-extractor Nuxt module</name>
  <files>modules/body-extractor.ts</files>
  <action>
Create `modules/body-extractor.ts` using `defineNuxtModule` from `@nuxt/kit`.

**Guard:** Only run during generate mode. Check `nuxt.options._generate` — if false, return early from setup. This prevents body extraction during `nuxt dev`.

**Phase A — afterParse hook (`content:file:afterParse`):**
- Hook into `content:file:afterParse` which receives a context with `content` object
- Skip files without a body (`if (!content.body) return`)
- Derive novel slug and chapter stem from `content.path` (e.g., `/mga/1` -> novel=`mga`, chapter=`1`). Split on `/`, filter empty parts. If fewer than 2 parts, skip (not a chapter).
- Write body JSON to staging directory: `{nuxt.options.buildDir}/body-extract/novels/{novel}/{chapter}.json` using `mkdirSync` (recursive) + `writeFileSync`. Use `JSON.stringify(content.body)` for minified output.
- Track in manifest array: `{ path: "/content/novels/{novel}/{chapter}.json", size: byteLength }`
- On first file extracted (`extractCount === 0`), log diagnostic info: body type, body keys, first 200 chars of JSON. This helps debug format issues.
- Increment extract counter.
- Replace body with empty minimark stub to strip it from the SQL dump:
  ```
  content.body = {
    type: 'minimark',
    value: [],
    toc: { title: '', searchDepth: 2, depth: 2, links: [] }
  }
  ```
  This matches the empty body format used by the existing strip-dump-bodies.mjs script.

**Phase B — close hook:**
- If extractCount is 0, return early (nothing to copy).
- Copy staged body files to `.output/public/content/` using `cpSync(stagingDir, destDir, { recursive: true })`. The destDir is `resolve(nuxt.options.rootDir, '.output/public/content')`.
- Write `bodies-manifest.json` to destDir with: `{ count, totalSize, files: manifestArray }`.
- Log summary: file count and total size in MB.

**Use original chapter stems (no zero-padding)** — source content files are `1.md`, `100.md`, `1886.md`. Using stems as-is avoids padding-width mismatch between build extraction and runtime fetch. This is within Claude's discretion per CONTEXT.md.

**Imports:** `defineNuxtModule` from `@nuxt/kit`, `mkdirSync`, `writeFileSync`, `cpSync` from `node:fs`, `resolve`, `dirname` from `node:path`.
  </action>
  <verify>
File exists at `modules/body-extractor.ts`. Contains `defineNuxtModule`, `content:file:afterParse` hook, `close` hook, staging directory logic, manifest generation. Has generate-only guard.
  </verify>
  <done>
Body-extractor module created with two-phase extraction: afterParse extracts bodies + strips from DB, close copies to output + writes manifest. Only active during `nuxt generate`.
  </done>
</task>

<task type="auto">
  <name>Task 2: Reconfigure build pipeline and clean up deprecated files</name>
  <files>nuxt.config.ts, content.config.ts, package.json, scripts/strip-dump-bodies.mjs</files>
  <action>
**nuxt.config.ts — major changes:**

1. **Delete** the `getChapterSlugs()` function at the top of the file (lines 1-14). No longer needed.

2. **Delete** the entire `nitro.hooks` block (the `prerender:routes` hook that adds 13K chapter routes). This is the key change that drops build from 26K routes to ~25.

3. **Update `modules` array** — add body-extractor module and reorder so sitemap is first:
   ```
   modules: ['@nuxtjs/sitemap', '@nuxt/content', '@nuxt/ui', '~/modules/body-extractor']
   ```
   Sitemap MUST be before content for `asSitemapCollection()` to work.

4. **Update `nitro.prerender.routes`** — add the ~25 explicit routes (novel listing pages were previously added by the hook). The full list:
   ```
   routes: [
     '/', '/200.html', '/404.html',
     '/novels',
     '/rss.xml',
     '/novels/mga', '/novels/atg', '/novels/overgeared', '/novels/tmw',
     '/novels/htk', '/novels/issth', '/novels/cd', '/novels/lrg',
     '/novels/mw', '/novels/rtw',
     '/novels/atg/rss.xml', '/novels/cd/rss.xml', '/novels/htk/rss.xml',
     '/novels/issth/rss.xml', '/novels/lrg/rss.xml', '/novels/mga/rss.xml',
     '/novels/mw/rss.xml', '/novels/overgeared/rss.xml', '/novels/rtw/rss.xml',
     '/novels/tmw/rss.xml',
   ]
   ```

5. **Add `spaLoadingTemplate`** config pointing to the loading template (will be created by Plan 05-02):
   ```
   spaLoadingTemplate: '~/app/spa-loading-template.html'
   ```

6. **Remove** the `import { readdirSync } from 'node:fs'` and `import { resolve } from 'node:path'` imports at the top (no longer needed after removing getChapterSlugs).

7. **Keep unchanged:** `content` block, `vite` block, `routeRules`, `compatibilityDate`, `css`, `site`, `sitemap`, `ignore`.

**content.config.ts — wrap collections with asSitemapCollection:**

1. Add import: `import { asSitemapCollection } from '@nuxtjs/sitemap/content'`
2. Wrap the `defineCollection()` call inside `novelCollection()` with `asSitemapCollection()`:
   ```typescript
   function novelCollection(dir: string) {
     return defineCollection(
       asSitemapCollection({
         type: 'page',
         source: `${dir}/**/*.md`,
         schema: chapterSchema,
       })
     )
   }
   ```
   This enables the sitemap module to discover all chapter URLs without prerendering them.

**package.json — update build script:**

Change `"build": "nuxt build"` to `"build": "nuxt generate"`. This enables the prerender pipeline that creates 200.html, HTML files, SQL dumps, and triggers the body-extractor module. The `deploy` script chains `pnpm build` so it automatically picks up the change.

**Delete scripts/strip-dump-bodies.mjs:**

This 166-line post-build SQL parsing script is replaced by the body-extractor module's afterParse hook. Delete the file entirely. Clean break per user decision.
  </action>
  <verify>
1. `nuxt.config.ts` has no `getChapterSlugs` function, no `prerender:routes` hook, has `~/modules/body-extractor` in modules, has `spaLoadingTemplate` config, has `/novels` and all 10 novel listing pages in prerender routes.
2. `content.config.ts` imports `asSitemapCollection` and wraps collection definitions.
3. `package.json` has `"build": "nuxt generate"`.
4. `scripts/strip-dump-bodies.mjs` does not exist.
5. Run `nuxt generate` (full build). Verify:
   - Body JSON files exist in `.output/public/content/novels/` (spot-check: `.output/public/content/novels/lrg/1.json` exists)
   - `bodies-manifest.json` exists with count ~13,318
   - SQL dump size: check `.output/public/__nuxt_content/` total size is under 5MB
   - Prerendered HTML count: `find .output/public -name '*.html' | wc -l` should be ~25-30 (not 26K)
   - Build time logged by Nuxt should be under 3 minutes
  </verify>
  <done>
Build pipeline reconfigured: nuxt generate produces body JSON files via body-extractor module, SQL dumps are body-stripped at parse time, only ~25 pages prerendered, deprecated strip script deleted. Build completes under 3 minutes.
  </done>
</task>

</tasks>

<verification>
After both tasks complete, run `nuxt generate` and verify:
1. **Body files:** `.output/public/content/novels/` contains subdirectories for all 10 novels with JSON files. `bodies-manifest.json` reports ~13,318 files.
2. **SQL dumps:** Total size of `.output/public/__nuxt_content/` is ~2-5MB (not 64MB).
3. **Prerendered pages:** `find .output/public -name 'index.html' | head -30` shows home, catalog, and novel listing pages only.
4. **Build time:** Under 3 minutes total (target 2 min).
5. **No regressions:** Prerendered pages (home, catalog, novel listings, RSS, sitemaps) render correctly.
</verification>

<success_criteria>
- `nuxt generate` completes successfully
- 13,318 body JSON files in `.output/public/content/novels/`
- `bodies-manifest.json` with accurate count and sizes
- SQL dumps are body-stripped (total <5MB)
- Only ~25 HTML pages prerendered
- Build time under 3 minutes
- No `scripts/strip-dump-bodies.mjs` in the repo
</success_criteria>

<output>
After completion, create `.planning/phases/05-build-pipeline-spa-foundation/05-01-SUMMARY.md`
</output>
