---
phase: 05-build-pipeline-spa-foundation
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - netlify.toml
  - app/spa-loading-template.html
  - public/_redirects
autonomous: true
requirements:
  - SPA-01

must_haves:
  truths:
    - "Visiting a chapter URL directly (e.g., /novels/mga/1) loads the SPA shell with branded loading page instead of returning 404"
    - "Prerendered static files (HTML, JS, CSS, body JSON) are served directly without redirect interference"
  artifacts:
    - path: "netlify.toml"
      provides: "Netlify redirect rule serving 200.html for chapter deep links"
      contains: "redirects"
    - path: "app/spa-loading-template.html"
      provides: "Branded SPA loading page with site name and spinner on dark background"
      contains: "Schaden Novel"
  key_links:
    - from: "netlify.toml"
      to: "200.html"
      via: "redirect rule rewrites /novels/*/* to /200.html with status 200"
      pattern: '/novels/\\*/\\*'
    - from: "app/spa-loading-template.html"
      to: "nuxt.config.ts spaLoadingTemplate"
      via: "Nuxt embeds this HTML into 200.html during generate"
      pattern: "spaLoadingTemplate"
---

<objective>
Create the SPA fallback routing infrastructure: a Netlify redirect rule that serves the SPA shell (200.html) for chapter deep links, and a branded loading template displayed while the Vue app initializes.

Purpose: Without SPA fallback, visiting a chapter URL directly would return 404 since chapters are no longer prerendered. The redirect + loading template provide a seamless entry point for all chapter URLs.
Output: `netlify.toml` with redirect rule, branded `spa-loading-template.html`, old `_redirects` file removed.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-build-pipeline-spa-foundation/05-RESEARCH.md
@public/_redirects
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Netlify SPA redirect and branded loading template</name>
  <files>netlify.toml, app/spa-loading-template.html, public/_redirects</files>
  <action>
**Create `netlify.toml` at project root** (NOT in `.netlify/` — that's Netlify CLI's auto-generated config):

```toml
[[redirects]]
  from = "/novels/*/*"
  to = "/200.html"
  status = 200
  force = false
```

Key details:
- `from = "/novels/*/*"` matches chapter URLs like `/novels/mga/1`, `/novels/atg/100`
- `to = "/200.html"` serves the Nuxt-generated SPA fallback shell
- `status = 200` makes it a rewrite (transparent to browser), not a visible redirect
- `force = false` is CRITICAL — Netlify serves existing static files first (prerendered HTML, JS, CSS, body JSON files in `/content/novels/`), only falls back to 200.html for routes without a matching static file

**Create `app/spa-loading-template.html`** — branded loading page per user decision (site logo centered, subtle spinner, dark theme):

```html
<div id="spa-loading" style="
  display: flex;
  align-items: center;
  justify-content: center;
  height: 100vh;
  background: #0a0a0a;
  color: #fafafa;
  font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
  margin: 0;
">
  <div style="text-align: center;">
    <div style="font-size: 1.5rem; font-weight: 600; margin-bottom: 1.5rem; letter-spacing: 0.02em;">
      Schaden Novel
    </div>
    <div style="
      width: 20px; height: 20px;
      border: 2px solid rgba(255, 255, 255, 0.15);
      border-top-color: rgba(255, 255, 255, 0.8);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      margin: 0 auto;
    "></div>
  </div>
</div>
<style>
  @keyframes spin { to { transform: rotate(360deg); } }
  body { margin: 0; }
</style>
```

All CSS is inline — no external dependencies. The `#spa-loading` div is automatically removed by Nuxt when the Vue app mounts. Dark background (#0a0a0a) matches the site's dark theme. Spinner is subtle and lightweight.

Nuxt picks this up via `spaLoadingTemplate: '~/app/spa-loading-template.html'` in nuxt.config.ts (configured in Plan 05-01 Task 2).

**Delete `public/_redirects`** — the catch-all `/* /200.html 200` rule is replaced by the more specific `netlify.toml` redirect targeting only chapter URLs (`/novels/*/*`). The _redirects file format is superseded by netlify.toml per user decision.
  </action>
  <verify>
1. `netlify.toml` exists at project root with `[[redirects]]` block, `from = "/novels/*/*"`, `status = 200`, `force = false`.
2. `app/spa-loading-template.html` exists with "Schaden Novel" text, spinner animation, dark background.
3. `public/_redirects` does not exist.
4. After `nuxt generate` (run in Plan 05-01), check that `.output/public/200.html` contains the branded loading content (grep for "Schaden Novel" or "spa-loading").
  </verify>
  <done>
SPA fallback infrastructure complete: netlify.toml rewrites chapter deep links to 200.html, branded loading template shows site name with spinner on dark background, old _redirects file removed.
  </done>
</task>

</tasks>

<verification>
1. `netlify.toml` at project root with correct redirect rule
2. `app/spa-loading-template.html` with branded dark-theme loading page
3. No `public/_redirects` file
4. After full build (Plan 05-01), `.output/public/200.html` contains the loading template content
5. Static files (prerendered HTML, JS, CSS, body JSON) are NOT affected by the redirect rule (force=false ensures existing files are served directly)
</verification>

<success_criteria>
- netlify.toml redirect serves 200.html for `/novels/*/*` patterns
- Branded loading page shows "Schaden Novel" with spinner on dark background
- Old _redirects file removed
- 200.html in build output contains the loading template
</success_criteria>

<output>
After completion, create `.planning/phases/05-build-pipeline-spa-foundation/05-02-SUMMARY.md`
</output>
