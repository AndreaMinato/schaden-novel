---
phase: 05-ssr-deploy-pipeline
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - nuxt.config.ts
  - package.json
  - netlify.toml
  - server/api/health.ts
  - public/_redirects
autonomous: true
requirements:
  - BUILD-01
  - BUILD-02
  - BUILD-03

must_haves:
  truths:
    - "nuxt.config.ts uses better-sqlite3 connector instead of native"
    - "@netlify/nuxt module is configured in modules array"
    - "Prerender routes hook removed — build will not enumerate 13K chapters"
    - "netlify.toml configures Netlify CI build with Node 22 and pnpm"
    - "Health check endpoint exists at /api/health querying SQLite"
    - "SPA fallback _redirects removed (SSR handles routing)"
  artifacts:
    - path: "nuxt.config.ts"
      provides: "SSR-mode Nuxt config with better-sqlite3 and @netlify/nuxt"
      contains: "better-sqlite3"
    - path: "netlify.toml"
      provides: "Netlify CI build configuration"
      contains: "nuxt build"
    - path: "server/api/health.ts"
      provides: "Health check endpoint proving SQLite works at runtime"
      exports: ["default"]
    - path: "package.json"
      provides: "Updated dependencies and scripts for SSR"
      contains: "better-sqlite3"
  key_links:
    - from: "nuxt.config.ts"
      to: "@netlify/nuxt"
      via: "modules array"
      pattern: "@netlify/nuxt"
    - from: "nuxt.config.ts"
      to: "better-sqlite3"
      via: "content.experimental.sqliteConnector"
      pattern: "better-sqlite3"
    - from: "server/api/health.ts"
      to: "queryCollection"
      via: "Nuxt Content server query"
      pattern: "queryCollection"
    - from: "netlify.toml"
      to: "nuxt build"
      via: "build command"
      pattern: "pnpm run build"
---

<objective>
Migrate the project from SSG (nuxt generate with 13K prerendered routes) to SSR build configuration. Switch SQLite connector to better-sqlite3 (node:sqlite unavailable on Lambda), add @netlify/nuxt for serverless integration, create netlify.toml for CI builds, add a health check endpoint, and remove SSG-era artifacts.

Purpose: Enable the project to produce a server function that renders pages on-demand instead of pre-building all 26K routes.
Output: SSR-ready configuration that passes `pnpm install` and is ready for `nuxt build`.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-ssr-deploy-pipeline/05-RESEARCH.md

@nuxt.config.ts
@package.json
@content.config.ts
@server/routes/rss.xml.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Migrate nuxt.config.ts to SSR mode and install dependencies</name>
  <files>nuxt.config.ts, package.json</files>
  <action>
**nuxt.config.ts changes:**

1. Remove the `getChapterSlugs()` function and its `readdirSync`/`resolve` imports at the top of the file. SSR does not prerender chapters.

2. Add `'@netlify/nuxt'` to the `modules` array (after existing modules).

3. In the `content` block, add `database` config and switch the connector:
```typescript
content: {
  database: {
    type: 'sqlite',
    filename: ':memory:',
  },
  experimental: {
    sqliteConnector: 'better-sqlite3',  // node:sqlite unavailable on AWS Lambda
  },
  watch: {
    enabled: false,
  },
},
```

4. In `nitro.prerender`:
   - Remove `/200.html` from `routes` array (SSR handles routing, no SPA fallback needed)
   - Keep `/`, `/404.html`, `/rss.xml`, and all per-novel RSS routes — these are small static pages worth prerendering
   - Keep `crawlLinks: false` and `concurrency: 4`

5. Remove the entire `nitro.hooks` block containing the `prerender:routes` function. This hook enumerates 13K chapters for prerendering — completely unnecessary in SSR mode. (Cleanup of other SSG patterns is Phase 6; this hook is the only one that blocks SSR build performance.)

6. Keep `routeRules: { '/': { prerender: true } }` as-is.

**package.json changes:**

1. Add to `dependencies`:
   - `"better-sqlite3": "^11.0.0"` (SQLite connector for Lambda runtime)
   - `"@netlify/nuxt": "^0.2.0"` (Netlify SSR adapter — ISR, CDN, serverless integration)

2. Add `"better-sqlite3"` to `pnpm.onlyBuiltDependencies` array (native module needs compilation).

3. Run `pnpm install` to install new dependencies.

**Do NOT:**
- Change content.config.ts (collections stay the same)
- Modify any server routes or pages (those work in both SSG and SSR)
- Remove the sitemap config (sitemaps still prerender fine)
- Touch zod version (3.25.76 is correct)
  </action>
  <verify>
Run `pnpm install` — must succeed with no errors. Verify nuxt.config.ts has no TypeScript/syntax errors by running `npx nuxt typecheck` or at minimum checking the file parses: `node -e "import('./nuxt.config.ts')"` (may fail due to TS, that's OK — visual inspection suffices).

Confirm: `grep -c 'better-sqlite3' nuxt.config.ts` returns 1. `grep -c '@netlify/nuxt' nuxt.config.ts` returns 1. `grep -c 'getChapterSlugs' nuxt.config.ts` returns 0. `grep -c 'prerender:routes' nuxt.config.ts` returns 0.
  </verify>
  <done>
nuxt.config.ts uses better-sqlite3 connector, includes @netlify/nuxt module, has no prerender:routes hook, and all dependencies install cleanly via pnpm.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create netlify.toml, health endpoint, and update deploy scripts</name>
  <files>netlify.toml, server/api/health.ts, package.json, public/_redirects</files>
  <action>
**Create `netlify.toml` at project root:**
```toml
[build]
  command = "pnpm run build"
  publish = ".output/public"

[build.environment]
  NODE_VERSION = "22"
  PNPM_FLAGS = "--shamefully-hoist"
```

Notes:
- `publish` must be `.output/public` — Netlify serves static files from here while the server function handles dynamic routes
- `NODE_VERSION = "22"` ensures Lambda runtime supports modern APIs
- `PNPM_FLAGS = "--shamefully-hoist"` ensures native modules like better-sqlite3 are resolvable
- Do NOT add `[functions]` section — @netlify/nuxt auto-configures the server function

**Create `server/api/health.ts`:**
```typescript
export default defineEventHandler(async () => {
  const start = performance.now()
  try {
    // Query one collection to prove SQLite database is working
    const chapters = await queryCollection('mga').count()
    const latency = Math.round(performance.now() - start)
    return {
      status: 'ok',
      database: 'sqlite',
      connector: 'better-sqlite3',
      latency_ms: latency,
      content_count: chapters,
      timestamp: new Date().toISOString(),
    }
  } catch (error: any) {
    return {
      status: 'error',
      database: 'sqlite',
      error: error.message,
      timestamp: new Date().toISOString(),
    }
  }
})
```

**Update `package.json` scripts:**
- Change `"preview"` from `"npx serve .output/public"` to `"nuxt preview"` (SSR preview uses the server function, not a static file server)
- Change `"deploy"` from `"pnpm build && netlify deploy --prod --dir=.output/public --no-build"` to `"pnpm build && netlify deploy --prod --build"` (SSR deploy needs Netlify to package the server function)
- Keep all other scripts unchanged

**Delete `public/_redirects`:**
This file contains `/* /200.html 200` for SPA fallback. SSR handles all routing through the server function — the fallback is unnecessary and could interfere with server-rendered responses.

**Do NOT:**
- Add environment variables to netlify.toml that contain secrets (those go in Netlify UI)
- Create `.nvmrc` or `.node-version` (NODE_VERSION in netlify.toml is sufficient)
- Modify server/routes/ (existing RSS routes work in SSR mode)
  </action>
  <verify>
Verify files exist and have correct content:
- `test -f netlify.toml && grep 'pnpm run build' netlify.toml` succeeds
- `test -f server/api/health.ts && grep 'queryCollection' server/api/health.ts` succeeds
- `test ! -f public/_redirects` (file deleted)
- `grep '"preview"' package.json` shows `nuxt preview`
  </verify>
  <done>
netlify.toml configures Netlify CI with Node 22 and pnpm. Health endpoint at /api/health queries SQLite to prove runtime database connectivity. Deploy scripts updated for SSR workflow. SPA fallback _redirects removed.
  </done>
</task>

</tasks>

<verification>
1. `pnpm install` completes without errors
2. nuxt.config.ts contains `better-sqlite3`, `@netlify/nuxt`, `:memory:` database, no `prerender:routes` hook
3. netlify.toml exists with correct build command and Node 22
4. server/api/health.ts exists with queryCollection call
5. public/_redirects does not exist
6. package.json has better-sqlite3 and @netlify/nuxt in dependencies
</verification>

<success_criteria>
All SSR configuration changes are in place. Dependencies install. The project is ready for `nuxt build` to produce a server function instead of 26K static HTML files.
</success_criteria>

<output>
After completion, create `.planning/phases/05-ssr-deploy-pipeline/05-01-SUMMARY.md`
</output>
