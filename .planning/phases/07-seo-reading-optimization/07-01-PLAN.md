---
phase: 07-seo-reading-optimization
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - server/api/__sitemap__/urls.ts
  - nuxt.config.ts
  - content.config.ts
autonomous: true
requirements: [SEO-01, SEO-02]

must_haves:
  truths:
    - "Sitemap index at /sitemap_index.xml lists per-novel sub-sitemaps and a pages sitemap"
    - "Each per-novel sitemap contains chapter URLs with /novels/{novel}/{slug} format"
    - "Total chapter URLs across all sitemaps equals ~13,318"
    - "RSS feeds (global + per-novel) return valid XML with chapter entries"
  artifacts:
    - path: "server/api/__sitemap__/urls.ts"
      provides: "Programmatic sitemap URL source querying all 10 content collections"
      contains: "defineSitemapEventHandler"
    - path: "nuxt.config.ts"
      provides: "Sitemap config with sources and per-novel sitemaps"
      contains: "sources.*__sitemap__/urls"
  key_links:
    - from: "server/api/__sitemap__/urls.ts"
      to: "queryCollection"
      via: "Content v3 server query"
      pattern: "queryCollection.*event.*novel"
    - from: "nuxt.config.ts"
      to: "server/api/__sitemap__/urls.ts"
      via: "sitemap sources config"
      pattern: "sources.*__sitemap__/urls"
---

<objective>
Fix empty per-novel sitemaps by replacing broken asSitemapCollection with a programmatic URL source endpoint, and verify RSS feeds remain functional in SPA mode.

Purpose: Search engines need to discover all 13,318 chapters via sitemaps. RSS feeds must continue working for feed readers.
Output: Working sitemap index with per-novel sub-sitemaps; verified RSS feeds.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-seo-reading-optimization/07-RESEARCH.md
@.planning/phases/05-build-pipeline-spa-foundation/05-01-SUMMARY.md
@nuxt.config.ts
@content.config.ts
@server/routes/rss.xml.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create sitemap URL source endpoint and update sitemap config</name>
  <files>server/api/__sitemap__/urls.ts, nuxt.config.ts, content.config.ts</files>
  <action>
1. Create `server/api/__sitemap__/urls.ts` using `defineSitemapEventHandler`:
   - Import `defineSitemapEventHandler` from `#imports`
   - Define NOVEL_SLUGS array: `['mga', 'atg', 'overgeared', 'tmw', 'htk', 'issth', 'cd', 'lrg', 'mw', 'rtw']`
   - For each novel, `queryCollection(event, novel as any).select('path', 'pubDate').all()`
   - Map each chapter to `{ loc: \`/novels${ch.path}\`, lastmod: ch.pubDate, _sitemap: novel }`
   - Use Promise.all for parallel queries, .flat() results
   - Wrap each novel query in try/catch, return [] on failure (graceful degradation)

2. Update `nuxt.config.ts` sitemap config:
   - Add `sources: ['/api/__sitemap__/urls']` at top level of sitemap config
   - Replace current sitemaps config with per-novel sitemaps using `include` patterns:
     - `pages`: `{ urls: ['/', '/novels', '/novels/mga', '/novels/atg', '/novels/overgeared', '/novels/tmw', '/novels/htk', '/novels/issth', '/novels/cd', '/novels/lrg', '/novels/mw', '/novels/rtw'], exclude: ['/novels/*/*'] }`
     - One entry per novel: `{ include: ['/novels/{novel}/**'] }`
   - Keep module order: sitemap before content (already correct per Phase 5)

3. Update `content.config.ts`:
   - Remove `asSitemapCollection` wrapper from all collection definitions (it adds no value with programmatic sources, per research)
   - Keep all other collection config unchanged

4. Build to verify: `pnpm generate`
   - Check `.output/public/sitemap_index.xml` exists and lists per-novel sitemaps
   - Check at least one per-novel sitemap (e.g., `.output/public/__sitemap__/mga.xml`) contains chapter URLs
   - Verify total URL count is ~13,318 across all per-novel sitemaps
  </action>
  <verify>
Run `pnpm generate` and verify:
- `.output/public/sitemap_index.xml` exists and references per-novel sitemaps
- `grep -c '<loc>' .output/public/__sitemap__/mga.xml` returns ~2335 (mga chapter count)
- `.output/public/__sitemap__/pages.xml` includes static pages like `/novels`
  </verify>
  <done>Sitemap index lists all per-novel sub-sitemaps; each sub-sitemap contains chapter URLs in /novels/{novel}/{slug} format; total chapter count ~13,318</done>
</task>

<task type="auto">
  <name>Task 2: Verify RSS feeds functional in SPA mode</name>
  <files>server/routes/rss.xml.ts</files>
  <action>
After the build from Task 1 completes, verify RSS feeds:

1. Check global RSS feed exists and is valid:
   - Verify `.output/public/rss.xml` exists
   - Verify it contains `<rss` XML tag and `<item>` entries
   - Verify `<link>` entries use correct URL format

2. Check per-novel RSS feeds exist and are valid:
   - Verify `.output/public/novels/mga/rss.xml` exists (and/or other novels with RSS prerender routes)
   - Verify it contains `<item>` entries with chapter links

3. No code changes expected per user decision ("verify only -- no code changes unless broken").
   If RSS feeds ARE broken (missing, empty, or malformed):
   - Diagnose the issue
   - Fix the minimal amount of code needed
   - Document what was broken and why

Note: The files field lists the RSS route file for reference only -- it should NOT be modified unless broken.
  </action>
  <verify>
- `.output/public/rss.xml` exists and contains valid RSS XML with `<item>` entries
- At least one per-novel RSS feed exists and contains `<item>` entries
- RSS links point to valid chapter URLs
  </verify>
  <done>RSS feeds (global + per-novel) confirmed functional in SPA mode with valid XML and chapter entries</done>
</task>

</tasks>

<verification>
- `pnpm generate` completes successfully
- Sitemap index at `.output/public/sitemap_index.xml` references all per-novel sitemaps
- Per-novel sitemaps contain chapter URLs (not empty)
- RSS feeds are valid XML with chapter entries
- No regressions in existing build output
</verification>

<success_criteria>
- All 13,318 chapters discoverable via sitemaps
- RSS feeds return valid XML
- Build still completes in under 2 minutes
</success_criteria>

<output>
After completion, create `.planning/phases/07-seo-reading-optimization/07-01-SUMMARY.md`
</output>
