---
// This component will be client-side rendered to access localStorage
---

<div class="resume-reading" id="resume-reading-container">
  <button class="resume-btn" id="resume-toggle" aria-expanded="false">
    <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"></path>
      <path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"></path>
    </svg>
    <span class="btn-text">Continua</span>
    <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <polyline points="6 9 12 15 18 9"></polyline>
    </svg>
  </button>
  <div class="dropdown" id="resume-dropdown">
    <div class="dropdown-empty" id="dropdown-empty">
      <p>Nessun capitolo salvato</p>
    </div>
    <ul class="dropdown-list" id="dropdown-list"></ul>
  </div>
</div>

<script>
  function getAllSavedNovels() {
    const savedChapters = JSON.parse(
      localStorage.getItem("savedChapters") || "{}",
    );
    const novels = Object.keys(savedChapters);

    if (novels.length === 0) {
      return [];
    }

    return novels
      .map((novel) => {
        const chapterData = savedChapters[novel];
        return {
          novel: novel,
          chapterId: chapterData?.chapterId,
          timestamp: chapterData?.timestamp || 0,
          url: chapterData?.chapterId
            ? `/novels/${chapterData.chapterId}/`
            : null,
        };
      })
      .filter((item) => item.chapterId && item.url)
      .sort((a, b) => b.timestamp - a.timestamp);
  }

  function updateResumeReadingDisplay() {
    const list = document.getElementById("dropdown-list");
    const empty = document.getElementById("dropdown-empty");
    if (!list || !empty) return;

    const savedNovels = getAllSavedNovels();
    list.innerHTML = "";

    if (savedNovels.length === 0) {
      empty.style.display = "block";
      list.style.display = "none";
      return;
    }

    empty.style.display = "none";
    list.style.display = "block";

    savedNovels.forEach((novel, index) => {
      if (novel.url) {
        const li = document.createElement("li");
        li.style.animationDelay = `${index * 30}ms`;

        const link = document.createElement("a");
        link.href = novel.url;

        const parts = novel.chapterId.split("/");
        const novelName = parts[0]?.toUpperCase() || "";
        const chapter = parts[1] || "";

        link.innerHTML = `
          <span class="novel-name">${novelName}</span>
          <span class="chapter-num">Cap. ${chapter}</span>
        `;

        li.appendChild(link);
        list.appendChild(li);
      }
    });
  }

  function toggleDropdown() {
    const btn = document.getElementById("resume-toggle");
    const dropdown = document.getElementById("resume-dropdown");
    if (!btn || !dropdown) return;

    const isOpen = btn.getAttribute("aria-expanded") === "true";
    btn.setAttribute("aria-expanded", String(!isOpen));
    dropdown.classList.toggle("open", !isOpen);
  }

  function closeDropdown() {
    const btn = document.getElementById("resume-toggle");
    const dropdown = document.getElementById("resume-dropdown");
    if (!btn || !dropdown) return;

    btn.setAttribute("aria-expanded", "false");
    dropdown.classList.remove("open");
  }

  // Initialize
  document.addEventListener("DOMContentLoaded", updateResumeReadingDisplay);
  window.addEventListener("storage", updateResumeReadingDisplay);

  const toggleBtn = document.getElementById("resume-toggle");
  toggleBtn?.addEventListener("click", (e) => {
    e.stopPropagation();
    toggleDropdown();
  });

  // Close when clicking outside
  document.addEventListener("click", (e) => {
    const container = document.getElementById("resume-reading-container");
    if (container && !container.contains(e.target as Node)) {
      closeDropdown();
    }
  });

  // Close on escape
  document.addEventListener("keydown", (e) => {
    if (e.key === "Escape") closeDropdown();
  });
</script>

<style>
  .resume-reading {
    position: relative;
  }

  .resume-btn {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem 0.85rem;
    background: linear-gradient(135deg, var(--accent) 0%, #6366f1 100%);
    color: white;
    border: none;
    border-radius: 8px;
    font-size: 0.875rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
    box-shadow: 0 2px 8px rgba(35, 55, 255, 0.25);
  }

  .resume-btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(35, 55, 255, 0.35);
  }

  .resume-btn:active {
    transform: translateY(0);
  }

  .resume-btn .icon {
    width: 16px;
    height: 16px;
    flex-shrink: 0;
  }

  .resume-btn .chevron {
    width: 14px;
    height: 14px;
    flex-shrink: 0;
    transition: transform 0.2s ease;
  }

  .resume-btn[aria-expanded="true"] .chevron {
    transform: rotate(180deg);
  }

  .dropdown {
    position: absolute;
    top: calc(100% + 8px);
    right: 0;
    min-width: 200px;
    background: white;
    border-radius: 12px;
    box-shadow:
      0 4px 6px rgba(0, 0, 0, 0.05),
      0 10px 24px rgba(0, 0, 0, 0.1);
    opacity: 0;
    visibility: hidden;
    transform: translateY(-8px);
    transition: all 0.2s ease;
    z-index: 1000;
    overflow: hidden;
  }

  .dropdown.open {
    opacity: 1;
    visibility: visible;
    transform: translateY(0);
  }

  .dropdown-empty {
    padding: 1.25rem;
    text-align: center;
  }

  .dropdown-empty p {
    margin: 0;
    color: rgb(var(--gray));
    font-size: 0.875rem;
  }

  .dropdown-list {
    list-style: none;
    padding: 0.5rem;
    margin: 0;
    max-height: 280px;
    overflow-y: auto;
  }

  .dropdown-list li {
    animation: slideIn 0.2s ease both;
  }

  @keyframes slideIn {
    from {
      opacity: 0;
      transform: translateX(-8px);
    }
    to {
      opacity: 1;
      transform: translateX(0);
    }
  }

  .dropdown-list a {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 1rem;
    padding: 0.75rem 1rem;
    border-radius: 8px;
    text-decoration: none;
    color: rgb(var(--gray-dark));
    transition: all 0.15s ease;
  }

  .dropdown-list a:hover {
    background: rgba(var(--gray-light), 0.6);
    color: var(--accent);
  }

  .novel-name {
    font-weight: 600;
    font-size: 0.8rem;
    letter-spacing: 0.02em;
  }

  .chapter-num {
    font-size: 0.75rem;
    color: rgb(var(--gray));
    background: rgba(var(--gray-light), 0.8);
    padding: 0.2rem 0.6rem;
    border-radius: 100px;
    white-space: nowrap;
  }

  .dropdown-list a:hover .chapter-num {
    background: rgba(35, 55, 255, 0.1);
    color: var(--accent);
  }

  @media (max-width: 480px) {
    .btn-text {
      display: none;
    }

    .resume-btn {
      padding: 0.6rem;
    }

    .resume-btn .chevron {
      display: none;
    }

    .dropdown {
      right: -1rem;
      min-width: 180px;
    }
  }
</style>
